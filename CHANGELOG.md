# Changelog

Ongoing log of changes to the scripts and playbooks in this repository.

## 2026-02

- **Snapshot docs: single clear procedure and clean-state reset:** **Setup-post-reboot.md** section 1c rewritten. One linear procedure: (1) Prerequisites (btrfs, swap note). (2) **Clean state**—only if you tried before: remove existing snapper configs and `.snapshots` (dir or subvolume) so create-config can run. (3) Install snapper. (4) Create configs (root, then home; if home fails use `home_vol`). (5) Use `list-configs` and the **exact** config names for create/list/rollback (avoids "Unknown config"). (6) Create factory snapshots and verify. (7) Rollback from root/live. Explicit: do not create `.snapshots` by hand or use raw `btrfs subvolume snapshot` for root/home. **PARTITION_LAYOUT_GUIDE.md**: point to full procedure and warn against manual .snapshots.

- **Snapshot docs: create-config troubleshooting and home_vol:** **Setup-post-reboot.md** section 1c: added an "If create-config fails" note covering (1) ".snapshots already exists" – remove directory or delete subvolume then retry; (2) "config already exists" for /home with no home in list-configs – use a different config name (e.g. `home_vol`) and use it in all later commands. Steps 4–6 now mention using your home config name (home or home_vol) for create/list/rollback.

- **Snapshot docs: snapper-only (grub-btrfs removed):** **Setup-post-reboot.md** and **PARTITION_LAYOUT_GUIDE.md** now describe snapshot management with snapper only. Removed all optional grub-btrfs content from Setup-post-reboot.md: section 1c retitled to "Snapshot management (snapper)", the optional boot menu integration block (apt install grub-btrfs / grub-btrfsd), grub-btrfsd from the verify step, and the grub-btrfs branch in the rollback workflow (rollback is now "from root shell or live with snapper rollback"). **PARTITION_LAYOUT_GUIDE.md**: snapshot manager recommendation and "Snapshot tooling suggestion" now reference only snapper and optional btrfs-assistant; rollback test steps updated to use `snapper rollback` from root/live.

- **Data root switched to `/data`:** Updated **ubuntu-setup.yml** and **post-reboot-verify.yml** so `app_data_path` defaults to `/data` and is treated as the data root (no nested `/data/data` path). Directory creation now targets `/data`, `/data/jpg`, `/data/video`, `/data/jpg/no_hook`, `/data/jpg/no_overlay`, `/data/ad_hoc`, `/data/ad_hoc/jpg`, and `/data/ad_hoc/video`. Updated related references in **DECISIONS.md**, **Setup-post-reboot.md**, **king_detector-drop-in/admin/SETUP.md**, and **king_detector-drop-in/admin/setup-crane-machine.sh** (including rsync examples and `MODEL_DIR` path expectations).

- **Post-reboot WiFi robustness + docs refresh + task numbering:** Updated **post-reboot-verify.yml** networking/WiFi flow to better handle open SSIDs and first-boot adapter state: installs `rfkill` and `iw` alongside NetworkManager; enables WiFi radio (`nmcli radio wifi on`), sets device managed, and attempts device connect before profile activation; binds both `OFFICEGST-2.4GHz` and `OFFICEGST-5GHz` profiles to the detected interface; clears WiFi security fields for open networks (`802-11-wireless-security.key-mgmt ""` and `psk ""`) instead of relying on explicit key-mgmt settings; keeps profiles unpinned to BSSID (no MAC lock); rescans and brings up named profiles directly (`nmcli connection up ...`) only when SSID is visible. Updated docs in **Setup-post-reboot.md** with a detailed terminal-first WiFi verification/troubleshooting workflow (rfkill/nmcli/iw checks, interface bring-up, profile validation, clean profile recreation, link/IP/route and log triage) and in **SETUP_WORKFLOW.md** to match open-network/no-BSSID behavior. Also added system-style task name numbering to every task in **post-reboot-verify.yml** (`1/53` … `53/53`) for consistency with **ubuntu-setup.yml**.

- **Recent WiFi/DKMS stabilization commits (latest series):** Improved WiFi strategy UX and reliability in **ubuntu-setup.yml** across the most recent commits: cleaner WiFi selection flow/menu behavior, DKMS path simplification, branch/repo handling fixes for RTL8812AU driver source, ensuring kernel gating logic does not incorrectly block the DKMS path, and re-checking/activating wireless state before final DKMS-option verification. This includes fixes around wireless interface state handling (for `wlx*`-style names) and variable/task robustness (`undefined` WiFi kernel variable and task-name wrapping/readability fixes).

- **Prompt timing moved later in run (operator workflow):** **ubuntu-setup.yml** now shows interface/MAC/IP information near completion instead of at the beginning, and the **Healthchecks.io URL prompt** was moved from early prompts to late in the run (right before Healthchecks service setup). Docs updated: **Install-system.md** and **SETUP_WORKFLOW.md**.

- **Git SSH key simplified to standard ed25519:** **ubuntu-setup.yml** Git setup now uses the standard `~/.ssh/id_ed25519` key (instead of creating `~/.ssh/id_ed25519_github`), displays `id_ed25519.pub` for GitHub, and removes the old managed GitHub-specific SSH config block if present. Docs updated to match in **Install-system.md** and **SETUP_WORKFLOW.md**.

- **WiFi strategy is now the first decision (with manual/test skip and DKMS option):** **ubuntu-setup.yml** now prompts early for a WiFi path before the main setup flow: (1) HWE kernel update path, (2) RTL8812AU DKMS path, (3) native Linux driver path, (4) manual/self-managed WiFi, (5) testing/no WiFi now (same behavior as manual). HWE kernel install/reboot gate runs only when option 1 is chosen. Manual/test options pre-select WiFi skip behavior so the run continues without WiFi enforcement. Added DKMS implementation for option 2 (`morrownr/8812au-20210820`) with post-install interface re-check and logging.

- **Kernel-first WiFi gating + native RTL8812AU path:** **ubuntu-setup.yml** now installs/pins Ubuntu 24.04 HWE kernel packages near the start and pins to `6.17.0-14-generic` (`linux-image`, `linux-headers`, `linux-modules`, `linux-modules-extra` with package hold). Added an early reboot gate: if the pinned kernel is not active yet, the run exits with a clear reboot-and-rerun message. WiFi readiness now runs immediately after that gate (before the rest of setup), keeps operator choice (`proceed`, `skip for this run`, `abort`), and uses native kernel support checks instead of cloning/installing `morrownr/8812au-20210820`. **Install-system.md**, **SETUP_WORKFLOW.md**, and **README.md** updated to document the two-pass flow on fresh machines.

- **WiFi readiness flow redesigned (deterministic + policy-aware):** **ubuntu-setup.yml** now runs WiFi checks as the first main stage after system update. Added deployment-mode prompt (`production` vs `test/check`) and a WiFi decision prompt so the operator explicitly approves the proposed action before any WiFi install/enforcement. Detection now installs `usbutils`/`pciutils` first, classifies adapters into: expected RTL8812AU (`0bda:8812`), different adapter, or no adapter, and checks whether a native wireless interface exists. RTL8812AU install path now uses a **pinned git revision** (`rtl8812au_repo_version`) instead of `main` for reproducibility. Outcome/status reporting now uses `rtl8812au_install_status` (not just adapter presence), including correct failure handling: in `production`, fail when WiFi is missing/unsupported or RTL8812AU driver install fails; in `test/check`, continue with warnings when appropriate.

- **RTL8812AU USB WiFi driver and WiFi-only shipping reminder:** **ubuntu-setup.yml** section 2b: when `lsusb` shows Realtek RTL8812AU (0bda:8812), the playbook installs dkms, bc, linux-headers-generic, clones morrownr/8812au-20210820 to `/opt/installers/8812au-20210820`, and runs `install-driver.sh NoPrompt` (non-interactive). Non-fatal (block/rescue). **post-reboot-verify.yml**: set WiFi device to managed (`nmcli device set … managed yes`); align both OFFICEGST-2.4GHz and OFFICEGST-5GHz profiles with `wifi-sec.key-mgmt none` (open network); final summary and log now include a **reminder to test connectivity over WiFi only (unplug ethernet) before shipping**. **CLAUDE.md** updated (RTL8812AU design pattern, playbook structure, WiFi reminder).

- **NetworkManager + netplan + WiFi (2.4/5 GHz profiles):** **post-reboot-verify.yml** section 8 now: (1) Installs NetworkManager (server default is systemd-networkd). (2) Writes **/etc/netplan/01-network-manager.yaml** (renderer NetworkManager only) and **99-machine-network.yaml** (ethernets: DHCP + camera static); applies netplan (safe even if SSID absent). (3) Creates two NetworkManager WiFi profiles without bringing them up: **OFFICEGST-2.4GHz** (wifi.band bg, autoconnect-priority 100) and **OFFICEGST-5GHz** (wifi.band a, autoconnect-priority 10); idempotent **modify** tasks keep settings aligned on every run. (4) Optional non-fatal connect only when SSID is visible: `nmcli -t -f SSID dev wifi list | grep -Fx "OFFICEGST"` then `nmcli dev wifi connect "OFFICEGST"`. Default SSID is **machine_wifi_ssid: OFFICEGST** (open network, no password). No NetworkManager restart during SSH bootstrap. **templates/01-network-manager.yaml** added; **DECISIONS.md** and **Setup-post-reboot.md** updated.

- **Networking and timezone in post-reboot-verify; app-deploy removed:** Machine setup is complete after `post-reboot-verify.yml`. That playbook now includes: **8. NETWORKING** – single netplan `/etc/netplan/99-machine-network.yaml` (default-route interface DHCP, other UP ethernet interfaces static 192.168.1.200, .201, …), optional backup and removal of `50-cloud-init.yaml` to avoid conflicts; **9. TIMEZONE** – set via Ansible `timezone` module (default `America/Chicago`, var `machine_timezone`). **app-deploy.yml** and its templates (99-camera-static.yaml.j2, crane-display-standalone.service.j2, env_king_detector.j2) have been removed. King_detector program setup (clone, .env, venv, pip, crane-display service, multi-user, GDM disable) is done by a setup script in the king_detector repo; see that repo’s admin/SETUP.md. **DECISIONS.md**, **Setup-post-reboot.md**, **SETUP_WORKFLOW.md**, **README.md**, **CLAUDE.md** updated accordingly. New template **templates/99-machine-network.yaml.j2** used by post-reboot-verify.

- **app-deploy.yml: system readiness check:** Before prompting for version/machine name, the playbook runs a short system check: DNS resolution (github.com), HTTPS reachability to GitHub, and that the deploy user exists. If any check fails, the playbook fails with a clear message so you can fix network/DNS and re-run.

- **app-deploy.yml: clone before netplan, netplan permissions:** Clone king_detector now runs as section 3 (right after packages), before the ethernet/netplan step (section 4), so DNS is unchanged when cloning and `netplan apply` cannot break name resolution. Netplan file `/etc/netplan/99-camera-static.yaml` mode set to `0600` to satisfy netplan and silence “permissions too open” warnings.

- **Third playbook: app-deploy.yml (king_detector):** New playbook at repo root, run after post-reboot-verify passes. Prompts for build version (branch, e.g. 2.9.0) and machine name (e.g. Mars2). Installs xdotool and x11-xserver-utils; detects ethernet interfaces with no internet and assigns static IPs (192.168.1.200, 192.168.1.201, …) via netplan 99-camera-static.yaml; clones king_detector from GitHub at the requested branch into ~/code/king_detector; creates .env from the repo’s admin/env-file.md (replacing mars2/Mars2 with machine name) or uses fallback template; ensures ~/data and ~/data/models; creates venv and installs from requirementsAutoUbuntu24cuda13.txt; installs and enables crane-display-standalone.service, sets multi-user default, disables GDM; sets timezone America/Chicago; prints manual steps (rsync models, camera time, SSH config, start crane). Templates in repo root **templates/**: crane-display-standalone.service.j2, 99-camera-static.yaml.j2, env_king_detector.j2. **CLAUDE.md** and **SETUP_WORKFLOW.md** updated to list the third playbook.

- **Setup-post-reboot.md:** Removed old section 8 (Python venv; now done by app-deploy). Reordered: data folders (7) → touch screen (8) → app deploy (9) → camera settings (10). New section 9 documents app-deploy: when to run, command, prompts, what it does, prerequisites, and the four manual steps after (rsync models, camera time, SSH config, start crane). Section 10 (camera settings) now says to run after app deploy. Renumbered rev4.3/tensor-check (11) and fwupd (12). App-deploy command documented as run-from-anywhere: `ansible-playbook ~/automated_setup_2025/app-deploy.yml -K -vv`.

- **App-deploy moved to repo root:** Playbook and templates moved from 2026-02/2/ to repo root: **app-deploy.yml** and **templates/** (crane-display-standalone.service.j2, 99-camera-static.yaml.j2, env_king_detector.j2). Removed 2026-02/2/app-deploy.yml and 2026-02/2/templates/*. **Setup-post-reboot.md**, **SETUP_WORKFLOW.md**, and **CLAUDE.md** updated to reference app-deploy.yml at root and to show the run-from-anywhere path.

- **Git/SSH: fix GitHub auth after adding key:** The playbook now configures `~/.ssh/config` with `Host github.com` and `IdentityFile ~/.ssh/id_ed25519_github` so SSH (and git) use the generated key for GitHub without needing `ssh-agent` or `ssh-add`. This fixes errors when cloning or pushing to GitHub after the user adds the key. The pause message notes that no ssh-agent is needed; **Install-system.md** documents the config and adds a troubleshooting line (run `eval "$(ssh-agent -s)"` and `ssh-add ~/.ssh/id_ed25519_github` if needed in GUI or non-interactive shells).

- **Scheduled reboot automated in playbook:** Section "5c. SCHEDULED REBOOT (root cron at 6 and 18)" added to **ubuntu-setup.yml**. The playbook now installs two root cron jobs: reboot at 06:00 and 18:00 (`/sbin/reboot`) and a log line (`echo "Cron executed at $(date)" >> /var/log/cron_test.log`). No manual crontab edit required. Final summary and log text updated to "Scheduled reboots at 6 and 18 (root cron installed by playbook)". **DECISIONS.md** and **Setup-post-reboot.md** updated to state that the playbook installs this by default.

- **Data folders path:** Data directories (`data/`, `data/jpg/`, `data/video/`, `data/jpg/no_hook`, `data/jpg/no_overlay`) are now created in the home directory by default (`~/data` next to `~/code`) instead of under `~/code/king_detector`. Updated `app_data_path` default from `{{ user_home }}/code/king_detector` to `{{ user_home }}` in **ubuntu-setup.yml** and **post-reboot-verify.yml**. Adjusted log message and task name; updated **DECISIONS.md** and **Setup-post-reboot.md** to describe the new default.

- **ubuntu-setup.yml (Git setup fix and move):** Fixed "unexpected parameter type in action: AnsibleSequence" on the "Set git user.name and user.email" task by changing `command` from a list to a string with `quote` filter: `command: 'git config --global {{ item.key | quote }} {{ item.value | quote }}'`. Moved the entire Git setup block (prompts for user.name/user.email, git config, GitHub SSH key generation, pause to add key) from section 5 (after firewall) to section 17 at the end of the playbook, so the user is prompted for Git identity at the end of the run rather than in the middle. Log and final summary now record "17. GIT SETUP" and include "Git configured (SSH for GitHub)" in the completion message.

- **Plan finalized:** Setup instructions and automation (2026-02). Implementation in progress: repo root CHANGELOG.md and DECISIONS.md created; ubuntu-setup.yml and docs to follow per 2026-02/PLAN.md.

- **ubuntu-setup.yml:** Removed section "5. AUTO-REBOOT SYSTEMD TIMER" (no daily-reboot.service/timer). Added at start: network info display (Ethernet/WiFi MACs, IPs). Added boot-mode prompt (GNOME vs minimal X). Added section "5. GIT SETUP": prompts for git user.name/user.email, `url.insteadOf` for GitHub SSH, generate `~/.ssh/id_ed25519_github`, display public key, pause to add key to GitHub. SSH block rewritten: ensure `~/.ssh`, deploy keys from `ssh-public-keys.txt` via `authorized_key`, set Port/PasswordAuthentication no/PubkeyAuthentication/PermitRootLogin via lineinfile (single place), notify restart sshd. Added section "5b. DATA FOLDERS": create `app_data_path` and data/jpg/video/no_hook/no_overlay. When boot_mode minimal_x: install xdotool, x11-xserver-utils.

- **post-reboot-verify.yml:** Added vars `app_data_path`. Added section "7. DATA FOLDERS": ensure app_data_path and create data/jpg/video/no_hook/no_overlay.

- **Install-system.md:** Replaced with section "0. Before Ubuntu" (ZeroTier correct URL, SSH, add key); SSH key reminder (installer or manual; playbook deploys from repo). Step 4: playbook does network info, healthchecks, boot mode, Git prompts, GitHub key, keys from repo, SSH lock-down; no systemd reboot (crontab only). Replaced long "Optional: Lock Down SSH" block with short note.

- **Setup-post-reboot.md:** Restructured as checklist (1–12): verify playbook, Firefox, crontab (exact two lines), VNC, VS Code, clone repo, data folders, venv, rev4.3, fwupd, touch screen (note for server+xinit), camera settings; boot mode note.

- **SETUP_WORKFLOW.md:** New file: full workflow, what’s automated vs manual, boot mode (GNOME vs minimal X), camera settings.

- **README.md:** Pointer to SETUP_WORKFLOW.md; sentence that ssh-public-keys.txt is used by the playbook to deploy keys to authorized_keys.
